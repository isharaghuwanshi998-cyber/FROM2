function doPost(e) {
  try {

    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    const d = e.parameter;

    const name = d.name || "";
    const lastName = d.lastName || "";
    const email = d.email || "";
    const rollNo = d.rollNo || "";
    const message = d.message || "";
    const date = new Date().toLocaleString();

    // ===== TEMPLATE ID =====
    const TEMPLATE_ID = "1-SgZ4dG2iCMfc1OE_-_QvKS94oZT1BCn0BXO6jX_KBM";

    // ===== COPY TEMPLATE =====
    const copy = DriveApp.getFileById(TEMPLATE_ID)
      .makeCopy(name + "_Student_Info");

    const doc = DocumentApp.openById(copy.getId());
    const body = doc.getBody();

    // ===== REPLACE PLACEHOLDERS =====
    body.replaceText("{{name}}", name);
    body.replaceText("{{lastName}}", lastName);
    body.replaceText("{{email}}", email);
    body.replaceText("{{rollNo}}", rollNo);
    body.replaceText("{{message}}", message);
    body.replaceText("{{date}}", date);

    doc.saveAndClose();

    const file = DriveApp.getFileById(doc.getId());
    const link = file.getUrl();

    // ===== SAVE DATA TO SHEET =====
    sheet.appendRow([
      new Date(),
      name,
      lastName,
      email,
      rollNo,
      message,
      link
    ]);

    // ===== SEND EMAIL =====
    MailApp.sendEmail({
      to: email,
      subject: "Your Student Information Submission",
      htmlBody: `
        <div style="font-family:Arial,sans-serif; padding:20px;">
          <h2 style="color:#4f46e5;">ðŸŽ“ Student Information Submitted</h2>

          <p>Hello <strong>${name} ${lastName}</strong>,</p>

          <p>Thank you for submitting your information. Here are your details:</p>

          <table style="border-collapse:collapse; width:100%; max-width:500px;">
            <tr><td><b>First Name:</b></td><td>${name}</td></tr>
            <tr><td><b>Last Name:</b></td><td>${lastName}</td></tr>
            <tr><td><b>Email:</b></td><td>${email}</td></tr>
            <tr><td><b>Roll No:</b></td><td>${rollNo}</td></tr>
            <tr><td><b>Message:</b></td><td>${message}</td></tr>
          </table>

          <br>
          <p>You can open your editable document here:</p>

          <a href="${link}"
            style="background:#4f46e5;color:white;padding:10px 15px;
            text-decoration:none;border-radius:6px;display:inline-block;">
            Open Google Doc
          </a>

          <p style="margin-top:20px;font-size:12px;color:#666;">
            PDF copy is attached for download.
          </p>
        </div>
      `,
      attachments: [file.getAs(MimeType.PDF)]
    });

    // ===== RESPONSE =====
    return ContentService
      .createTextOutput(JSON.stringify({
        status: "success",
        link: link
      }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (err) {

    return ContentService
      .createTextOutput(JSON.stringify({
        status: "error",
        message: err.message
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}


// ===== OPTIONAL EMAIL PERMISSION TEST =====
function testEmailPermission() {
  MailApp.sendEmail({
    to: "yourgmail@gmail.com",
    subject: "Permission Test",
    body: "Testing email permission"
  });
}
